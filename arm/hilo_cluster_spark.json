{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "clusterName": {
            "type": "String",
            "metadata": {
                "description": "The name of the HDInsight cluster Gen2 to create"
            }
        },
        "clusterPoolName": {
            "type": "String",
            "metadata": {
                "description": "The name of the HDInsight cluster pool where the cluster to be created"
            }
        },
        "location": {
            "type": "String",
            "metadata": {
                "description": "The location where all Azure resources will be deployed"
            }
        },
        "clusterType": {
            "type": "String",
            "metadata": {
                "description": "The type of the cluster to be created"
            }
        },
        "workerNodeVMSize": {
            "type": "String",
            "metadata": {
                "description": "VM SKU selected for the worker node"
            }
        },
        "workerNodeCount": {
            "type": "String",
            "metadata": {
                "description": "Worker node count"
            }
        },
        "clusterVersion": {
            "type": "String",
            "metadata": {
                "description": "The version of the cluster to be created"
            }
        },
        "currentUserObjectId": {
            "type": "String",
            "metadata": {
                "description": "Object id of the logged in user"
            }
        },
        "msiResourceId": {
            "type": "String",
            "metadata": {
                "description": "User managed identity resource id"
            }
        },
        "msiClientId": {
            "type": "String",
            "metadata": {
                "description": "User managed identity client id"
            }
        },
        "msiObjectId": {
            "type": "String",
            "metadata": {
                "description": "User managed identity object id"
            }
        },
        "isLogAnalyticsEnabled": {
            "type": "Bool",
            "metadata": {
                "description": "Flag which enables Log Analytics for the cluster"
            }
        },
        "isLogAnalyticsStdErrorEnabled": {
            "type": "Bool",
            "metadata": {
                "description": "Flag which enables standard error logs ingestion to Log Analytics workspace"
            }
        },
        "isLogAnalyticsStdOutEnabled": {
            "type": "Bool",
            "metadata": {
                "description": "Flag which enables standard out logs ingestion to Log Analytics workspace"
            }
        },
        "isLogAnalyticsMetricsEnabled": {
            "type": "Bool",
            "metadata": {
                "description": "Flag which enables JMX metrics ingestion to Log Analytics workspace"
            }
        },
        "storageAccountEndpoint": {
            "type": "String",
            "metadata": {
                "description": "Storage account endpoint"
            }
        },
        "storageAccountContainer": {
            "type": "String",
            "metadata": {
                "description": "Filesystem/container in the given storage"
            }
        },
        "secureShellNodeCount": {
            "type": "String",
            "metadata": {
                "description": "Secure shell (SSH) pod count"
            }
        },
        "secureShellPodPrefix": {
            "type": "String",
            "metadata": {
                "description": "Secure shell (SSH) endpoint prefix"
            }
        }
    },
    "variables": {
        "clusterGen2ApiVersion": "2021-09-15-preview",
        "intWorkerNodeCount": "[int(parameters('workerNodeCount'))]",
        "fullClusterName": "[concat(parameters('clusterPoolName'), '/', parameters('clusterName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.HDInsight/clusterpools/clusters",
            "apiVersion": "[variables('clusterGen2ApiVersion')]",
            "name": "[variables('fullClusterName')]",
            "location": "[parameters('location')]",
            "tags": {},
            "properties": {
                "clusterType": "[parameters('clusterType')]",
                "computeProfile": {
                    "vmSize": "[parameters('workerNodeVMSize')]",
                    "count": "[variables('intWorkerNodeCount')]"
                },
                "clusterProfile": {
                    "stackVersion": "[parameters('clusterVersion')]",
                    "identityProfile": {
                        "msiResourceId": "[parameters('msiResourceId')]",
                        "msiClientId": "[parameters('msiClientId')]",
                        "msiObjectId": "[parameters('msiObjectId')]"
                    },
                    "authorizationProfile": {
                        "userIds": "[array(parameters('currentUserObjectId'))]"
                    },
                    "secretsProfile": null,
                    "serviceConfigsProfiles": [],
                    "logAnalyticsProfile": {
                        "enabled": "[bool(parameters('isLogAnalyticsEnabled'))]",
                        "applicationLogs": {
                            "stdErrorEnabled": "[bool(parameters('isLogAnalyticsStdErrorEnabled'))]",
                            "stdOutEnabled": "[bool(parameters('isLogAnalyticsStdOutEnabled'))]"
                        },
                        "metricsEnabled": "[bool(parameters('isLogAnalyticsMetricsEnabled'))]"
                    },
                    "sshProfile": {
                        "count": "[int(parameters('secureShellNodeCount'))]",
                        "podPrefix": "[parameters('secureShellPodPrefix')]"
                    },
                    "sparkProfile": {
                        "defaultStorageUrl": "[concat('abfs://',parameters('storageAccountContainer'), '@', parameters('storageAccountEndpoint'),'/')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "name": "[guid('rg-aimurg-eu2', 'staimurgeu2')]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                            "name": "staimurgeu2/default/spark01",
                            "apiVersion": "2021-04-01",
                            "properties": {}
                        }
                    ]
                },
                "parameters": {}
            },
            "subscriptionId": "d66b1168-d835-4066-8c45-7d2ed713c082",
            "resourceGroup": "rg-aimurg-eu2"
        }
    ]
}