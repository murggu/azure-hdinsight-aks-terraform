{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "clusterName": {
            "type": "string",
            "metadata": {
                "description": "The name of the HDInsight cluster Gen2 to create"
            }
        },
        "clusterPoolName": {
            "type": "string",
            "metadata": {
                "description": "The name of the HDInsight cluster pool where the cluster to be created"
            }
        },
        "location": {
            "type": "string",
            "metadata": {
                "description": "The location where all Azure resources will be deployed"
            }
        },
        "clusterType": {
            "type": "string",
            "metadata": {
                "description": "The type of the cluster to be created"
            }
        },
        "workerNodeVMSize": {
            "type": "string",
            "metadata": {
                "description": "VM SKU selected for the worker node"
            }
        },
        "workerNodeCount": {
            "type": "string",
            "metadata": {
                "description": "Worker node count"
            }
        },
        "clusterVersion": {
            "type": "string",
            "metadata": {
                "description": "The version of the cluster to be created"
            }
        },
        "currentUserObjectId": {
            "type": "string",
            "metadata": {
                "description": "Object id of the logged in user"
            }
        },
        "msiResourceId": {
            "type": "string",
            "metadata": {
                "description": "User managed identity resource id"
            }
        },
        "msiClientId": {
            "type": "string",
            "metadata": {
                "description": "User managed identity client id"
            }
        },
        "msiObjectId": {
            "type": "string",
            "metadata": {
                "description": "User managed identity object id"
            }
        },
        "isLogAnalyticsEnabled": {
            "type": "bool",
            "metadata": {
                "description": "Flag which enables Log Analytics for the cluster"
            }
        },
        "isLogAnalyticsStdErrorEnabled": {
            "type": "bool",
            "metadata": {
                "description": "Flag which enables standard error logs ingestion to Log Analytics workspace"
            }
        },
        "isLogAnalyticsStdOutEnabled": {
            "type": "bool",
            "metadata": {
                "description": "Flag which enables standard out logs ingestion to Log Analytics workspace"
            }
        },
        "isLogAnalyticsMetricsEnabled": {
            "type": "bool",
            "metadata": {
                "description": "Flag which enables JMX metrics ingestion to Log Analytics workspace"
            }
        },
        "storageAccountEndpoint": {
            "type": "string",
            "metadata": {
                "description": "Session cluster's storage account endpoint"
            }
        },
        "storageAccountContainer": {
            "type": "string",
            "metadata": {
                "description": "Session cluster's storage container name"
            }
        },
        "taskManagerCount": {
            "type": "string",
            "metadata": {
                "description": "Task manager count"
            }
        },
        "taskManagerCPU": {
            "type": "string",
            "metadata": {
                "description": "Task manager CPU count"
            }
        },
        "taskManagerMemoryInMB": {
            "type": "string",
            "metadata": {
                "description": "Task manager memory in MB"
            }
        },
        "jobManagerCPU": {
            "type": "string",
            "metadata": {
                "description": "Job manager CPU count"
            }
        },
        "jobManagerMemoryInMB": {
            "type": "string",
            "metadata": {
                "description": "Job manager memory in MB"
            }
        },
        "historyServerCPU": {
            "type": "string",
            "metadata": {
                "description": "Job manager CPU count"
            }
        },
        "historyServerMemoryInMB": {
            "type": "string",
            "metadata": {
                "description": "Job manager memory in MB"
            }
        },
        "secureShellNodeCount": {
            "type": "string",
            "metadata": {
                "description": "Secure shell (SSH) pod count"
            }
        },
        "secureShellPodPrefix": {
            "type": "string",
            "metadata": {
                "description": "Secure shell (SSH) endpoint prefix"
            }
        }
    },
    "variables": {
        "clusterGen2ApiVersion": "2021-09-15-preview",
        "intWorkerNodeCount": "[int(parameters('workerNodeCount'))]",
        "fullClusterName": "[concat(parameters('clusterPoolName'), '/', parameters('clusterName'))]"
    },
    "resources": [
        {
            "name": "[variables('fullClusterName')]",
            "type": "Microsoft.HDInsight/clusterpools/clusters",
            "location": "[parameters('location')]",
            "apiVersion": "[variables('clusterGen2ApiVersion')]",
            "tags": {},
            "properties": {
                "clusterType": "[parameters('clusterType')]",
                "computeProfile": {
                    "vmSize": "[parameters('workerNodeVMSize')]",
                    "count": "[variables('intWorkerNodeCount')]"
                },
                "clusterProfile": {
                    "stackVersion": "[parameters('clusterVersion')]",
                    "identityProfile": {
                        "msiResourceId": "[parameters('msiResourceId')]",
                        "msiClientId": "[parameters('msiClientId')]",
                        "msiObjectId": "[parameters('msiObjectId')]"
                    },
                    "authorizationProfile": {
                        "userIds": "[array(parameters('currentUserObjectId'))]"
                    },
                    "secretsProfile": null,
                    "serviceConfigsProfiles": [],
                    "logAnalyticsProfile": {
                        "enabled": "[bool(parameters('isLogAnalyticsEnabled'))]",
                        "applicationLogs": {
                            "stdErrorEnabled": "[bool(parameters('isLogAnalyticsStdErrorEnabled'))]",
                            "stdOutEnabled": "[bool(parameters('isLogAnalyticsStdOutEnabled'))]"
                        },
                        "metricsEnabled": "[bool(parameters('isLogAnalyticsMetricsEnabled'))]"
                    },
                    "sshProfile": {
                        "count": "[int(parameters('secureShellNodeCount'))]",
                        "podPrefix": "[parameters('secureShellPodPrefix')]"
                    },
                    "flinkProfile": {
                        "numReplicas": "[int(parameters('taskManagerCount'))]",
                        "jobManager": {
                            "cpu": "[int(parameters('jobManagerCPU'))]",
                            "memory": "[int(parameters('jobManagerMemoryInMB'))]"
                        },
                        "taskManager": {
                            "cpu": "[int(parameters('taskManagerCPU'))]",
                            "memory": "[int(parameters('taskManagerMemoryInMB'))]"
                        },
                        "historyServer": {
                            "cpu": "[int(parameters('historyServerCPU'))]",
                            "memory": "[int(parameters('historyServerMemoryInMB'))]"
                        },
                        "storage": {
                            "storageUri": "[concat('abfs://',parameters('storageAccountContainer'), '@', parameters('storageAccountEndpoint'))]"
                        }
                    }
                }
            }
        }
    ]
}